--[[
    [서버 매니저 v6 - 만렙 경험치 제한 완전 해제]
    수정 사항:
    1. '만렙이면 경험치 획득 중단' 코드를 삭제하여 경험치가 계속 쌓이도록 수정
    2. 레벨업 반복문(while) 안에서만 레벨 제한을 걸어, 레벨은 멈추고 경험치만 쌓이게 함
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- 리모트 이벤트 자동 생성
local remoteFolder = ReplicatedStorage:FindFirstChild("Remotes")
if not remoteFolder then
	remoteFolder = Instance.new("Folder")
	remoteFolder.Name = "Remotes"
	remoteFolder.Parent = ReplicatedStorage
end

local function createRemote(name)
	if not remoteFolder:FindFirstChild(name) then
		local re = Instance.new("RemoteEvent")
		re.Name = name
		re.Parent = remoteFolder
	end
end

createRemote("GainExp") 
createRemote("MobKill") 
createRemote("UpdateStats")
createRemote("Rebirth") 

-- 설정
local BASE_EXP = 10 
local BASE_EXP_REQ = 100 
local EXP_EXPONENT = 1.14 
local BASE_MAX_LEVEL = 25 

Players.PlayerAdded:Connect(function(player)
	-- 리더보드
	local leaderstats = Instance.new("Folder")
	leaderstats.Name = "leaderstats"
	leaderstats.Parent = player

	local level = Instance.new("IntValue")
	level.Name = "Level"
	level.Value = 1
	level.Parent = leaderstats

	local rebirth = Instance.new("IntValue")
	rebirth.Name = "Rebirth"
	rebirth.Value = 0
	rebirth.Parent = leaderstats

	local coins = Instance.new("IntValue")
	coins.Name = "Coins"
	coins.Value = 0
	coins.Parent = leaderstats

	-- 숨겨진 스탯
	local hidden = Instance.new("Folder")
	hidden.Name = "HiddenStats"
	hidden.Parent = player

	local currentExp = Instance.new("IntValue")
	currentExp.Name = "CurrentExp"
	currentExp.Value = 0
	currentExp.Parent = hidden

	local maxExp = Instance.new("IntValue")
	maxExp.Name = "MaxExp"
	maxExp.Value = BASE_EXP_REQ
	maxExp.Parent = hidden
	
	local robuxMult = Instance.new("IntValue")
	robuxMult.Name = "RobuxMultiplier"
	robuxMult.Value = 1 
	robuxMult.Parent = hidden
end)

local function calculateMultiplier(player)
	local rebirth = player.leaderstats.Rebirth.Value
	local robuxMult = player.HiddenStats.RobuxMultiplier.Value
	
	local rebirthMult = 1 + (rebirth * 0.5)
	return robuxMult * rebirthMult
end

-- 경험치 획득 (무한 누적 가능)
remoteFolder.GainExp.OnServerEvent:Connect(function(player)
	local stats = player:FindFirstChild("leaderstats")
	local hidden = player:FindFirstChild("HiddenStats")
	if not stats then return end
	
	-- 현재 환생 횟수에 따른 만렙 제한
	local levelCap = BASE_MAX_LEVEL + (stats.Rebirth.Value * 25)
	
	-- [핵심 수정] 예전에는 여기서 만렙이면 return으로 끝내버렸지만, 이제는 통과시킵니다!
	-- if stats.Level.Value >= levelCap then return end (삭제됨)

	local amount = BASE_EXP * calculateMultiplier(player)
	hidden.CurrentExp.Value = hidden.CurrentExp.Value + amount
	
	-- 경험치가 요구량보다 많으면 레벨업 시도
	while hidden.CurrentExp.Value >= hidden.MaxExp.Value do
		-- [핵심] 여기서 만렙인지 체크! 만렙이면 레벨업을 멈추고 반복문 탈출
		-- 결과적으로 경험치(CurrentExp)는 깎이지 않고 계속 쌓여있게 됨
		if stats.Level.Value >= levelCap then
			break 
		end

		hidden.CurrentExp.Value = hidden.CurrentExp.Value - hidden.MaxExp.Value
		stats.Level.Value = stats.Level.Value + 1
		hidden.MaxExp.Value = math.floor(BASE_EXP_REQ * (EXP_EXPONENT ^ (stats.Level.Value - 1)))
	end
	
	remoteFolder.UpdateStats:FireClient(player)
end)

-- 몹 처치
remoteFolder.MobKill.OnServerEvent:Connect(function(player, mobName)
	local coins = player.leaderstats.Coins
	coins.Value = coins.Value + 10 
end)

-- 환생 처리
remoteFolder.Rebirth.OnServerEvent:Connect(function(player)
	local stats = player:FindFirstChild("leaderstats")
	local hidden = player:FindFirstChild("HiddenStats")
	if not stats then return end
	
	local level = stats.Level
	local rebirth = stats.Rebirth
	
	local requiredLevel = BASE_MAX_LEVEL + (rebirth.Value * 25)
	
	if level.Value >= requiredLevel then
		rebirth.Value = rebirth.Value + 1
		
		-- 초기화
		level.Value = 1
		hidden.CurrentExp.Value = 0 
		hidden.MaxExp.Value = BASE_EXP_REQ 
		
		print(player.Name .. "님 환생 성공! 현재 환생: " .. rebirth.Value)
		player:LoadCharacter()
	end
end)
