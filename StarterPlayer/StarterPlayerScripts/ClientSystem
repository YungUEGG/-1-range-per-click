--[[
    [í´ë¼ì´ì–¸íŠ¸ ì‹œìŠ¤í…œ í†µí•© v46 - ê³µê²© íŒì • ë²”ìœ„ ìˆ˜ì •]
    ìœ„ì¹˜: StarterPlayerScripts > ClientSystem
    
    [ìˆ˜ì • ì‚¬í•­]
    1. ê³µê²© íŒì •(Hit Detection) ìˆ˜ì •: 
       - ê¸°ì¡´: Handleì— ë‹¿ì•˜ì„ ë•Œë§Œ ê³µê²© ì¸ì •
       - ë³€ê²½: Handle(ì†ì¡ì´) ë˜ëŠ” Blade(ì¹¼ë‚ )ì— ë‹¿ì•˜ì„ ë•Œ ê³µê²© ì¸ì •
    2. ì´ì „ ìˆ˜ì • ì‚¬í•­(ì„±ì¥ ì¶• Y, ìœ„ì¹˜ ë³´ì •, UI ë“±) ëª¨ë‘ ìœ ì§€
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local remotes = ReplicatedStorage:WaitForChild("Remotes", 10)
local ShopConfig = require(ReplicatedStorage:WaitForChild("ShopConfig", 10))

-- [ì•ˆì „ì¥ì¹˜]
if not remotes or not ShopConfig then
	warn("í•„ìˆ˜ ìš”ì†Œ(Remotes ë˜ëŠ” ShopConfig)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
	return
end

-- ë¡œë”© ëŒ€ê¸°
print("ClientSystem: ë¡œë”© ì‹œì‘...")
task.wait(1)

------------------------------------------------------------------
-- 0. ê³µí†µ UI í•¨ìˆ˜
------------------------------------------------------------------
local uiConnections = {} 
local currentSelectedID = 1 

local function clearUIConnections()
	for _, conn in pairs(uiConnections) do
		if conn then conn:Disconnect() end
	end
	uiConnections = {}
end

local function addHoverEffect(btn)
	if not btn then return end
	if btn:FindFirstChild("HoverShade") then btn.HoverShade:Destroy() end

	local hoverFrame = Instance.new("Frame")
	hoverFrame.Name = "HoverShade"
	hoverFrame.Size = UDim2.new(1, 0, 1, 0)
	hoverFrame.BackgroundColor3 = Color3.new(0, 0, 0)
	hoverFrame.BackgroundTransparency = 1 
	hoverFrame.ZIndex = (btn.ZIndex or 1) + 10 
	hoverFrame.Parent = btn

	local corner = btn:FindFirstChild("UICorner") and btn.UICorner:Clone() or Instance.new("UICorner")
	if not btn:FindFirstChild("UICorner") then corner.CornerRadius = UDim.new(0, 8) end
	corner.Parent = hoverFrame

	btn.MouseEnter:Connect(function()
		TweenService:Create(hoverFrame, TweenInfo.new(0.2), {BackgroundTransparency = 0.8}):Play()
	end)
	btn.MouseLeave:Connect(function()
		TweenService:Create(hoverFrame, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play()
	end)
end

local function createExpBar(screenGui)
	if screenGui:FindFirstChild("ExpBarBackground") then return screenGui.ExpBarBackground end

	local expBg = Instance.new("Frame")
	expBg.Name = "ExpBarBackground"
	expBg.Size = UDim2.new(0.4, 0, 0.05, 0)
	expBg.Position = UDim2.new(0.3, 0, 0.85, 0)
	expBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	expBg.BorderSizePixel = 2
	expBg.ZIndex = 0 
	expBg.Parent = screenGui

	local fill = Instance.new("Frame")
	fill.Name = "ExpBarFill"
	fill.Size = UDim2.new(0, 0, 1, 0)
	fill.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
	fill.BorderSizePixel = 0
	fill.ZIndex = 0 
	fill.Parent = expBg

	local txt = Instance.new("TextLabel")
	txt.Name = "LevelText"
	txt.Size = UDim2.new(1, 0, 1, 0)
	txt.BackgroundTransparency = 1
	txt.Text = "Loading..."
	txt.TextColor3 = Color3.new(1, 1, 1)
	txt.Font = Enum.Font.LuckiestGuy 
	txt.TextScaled = true
	txt.ZIndex = 1 
	txt.Parent = expBg

	return expBg
end

------------------------------------------------------------------
-- 1. ë©”ì¸ UI ì—°ê²° í•¨ìˆ˜
------------------------------------------------------------------
local function connectGameUI()
	clearUIConnections()
	print("ClientSystem: UI ì—°ê²° ì‹œë„ ì¤‘...")

	local playerGui = player:WaitForChild("PlayerGui", 10)
	if not playerGui then return end 

	local hud = playerGui:FindFirstChild("GameHUD")
	if not hud then
		hud = Instance.new("ScreenGui")
		hud.Name = "GameHUD"
		hud.ResetOnSpawn = false
		hud.DisplayOrder = 1 
		hud.Parent = playerGui
	end
	hud.ResetOnSpawn = false

	-- ìŠ¤íƒ¯ ë¡œë”©
	local leaderstats = player:WaitForChild("leaderstats", 5)
	local hidden = player:WaitForChild("HiddenStats", 5)

	if not leaderstats or not hidden then
		warn("ìŠ¤íƒ¯ ë¡œë”© ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.")
		task.delay(1, connectGameUI) 
		return 
	end

	local level = leaderstats:WaitForChild("Level", 5)
	local rebirth = leaderstats:WaitForChild("Rebirth", 5)
	local coins = leaderstats:WaitForChild("Coins", 5)
	local currentExp = hidden:WaitForChild("CurrentExp", 5)
	local maxExp = hidden:WaitForChild("MaxExp", 5)
	local equippedID = hidden:WaitForChild("EquippedSwordID", 5)

	if not (level and rebirth and coins and currentExp and maxExp and equippedID) then
		warn("ì„¸ë¶€ ìŠ¤íƒ¯ ë¡œë”© ì‹¤íŒ¨")
		return
	end

	-- ==========================================================
	-- [A] ìƒì  ì‹œìŠ¤í…œ
	-- ==========================================================
	local shopGui = playerGui:WaitForChild("ShopGui", 5)
	local shopFrame = shopGui and shopGui:FindFirstChild("ShopFrame")

	if shopFrame then
		local container = shopFrame:FindFirstChild("ItemsContainer")
		local template = container and container:FindFirstChild("ItemTemplate")
		local rightPanel = shopFrame:FindFirstChild("RightPanel") 
		local closeBtn = shopFrame:FindFirstChild("CloseBtn")

		local previewName = rightPanel and rightPanel:FindFirstChild("PreviewName")
		local previewImage = rightPanel and rightPanel:FindFirstChild("PreviewImage")
		local previewStats = rightPanel and rightPanel:FindFirstChild("PreviewStats")
		local previewPrice = rightPanel and rightPanel:FindFirstChild("PreviewPrice")
		local actionBtn = rightPanel and rightPanel:FindFirstChild("ActionBtn")

		addHoverEffect(actionBtn)

		local function updateListVisuals()
			if not container then return end
			for _, item in pairs(container:GetChildren()) do
				if item:IsA("GuiObject") and item.Name:match("Item_") then
					local idStr = item.Name:gsub("Item_", "")
					local id = tonumber(idStr)

					local normalBG = item:FindFirstChild("NormalBG")
					local selectedBG = item:FindFirstChild("SelectedBG")

					if normalBG and selectedBG then
						selectedBG.Visible = (id == currentSelectedID)
						normalBG.Visible = (id ~= currentSelectedID)
					else
						if id == currentSelectedID then
							item.BackgroundColor3 = Color3.fromRGB(255, 255, 200)
						else
							item.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
						end
					end
				end
			end
		end

		local function updatePreview(id)
			currentSelectedID = id
			updateListVisuals()

			local data = ShopConfig[id]
			if not data then return end

			if previewName then 
				previewName.Text = data.Name 
				previewName.Font = Enum.Font.LuckiestGuy 
			end
			if previewImage then previewImage.Image = data.ImageId end

			if previewStats then 
				local dmg = data.Damage or 10
				local exp = data.ExpAmount or 10
				previewStats.Text = "ATK +" .. dmg .. "\nEXP +" .. exp
				previewStats.Font = Enum.Font.LuckiestGuy 
			end

			local ownedStr = player:GetAttribute("OwnedSwords") or ""
			local hasItem = string.find(ownedStr, id .. ",")
			local isEquipped = (equippedID.Value == id)

			if actionBtn and previewPrice then
				actionBtn.Font = Enum.Font.LuckiestGuy 
				previewPrice.Font = Enum.Font.LuckiestGuy 

				if isEquipped then
					actionBtn.Text = "ì¥ì°© ì¤‘"
					actionBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
					actionBtn.Active = false
					previewPrice.Text = "ë³´ìœ ì¤‘"
				elseif hasItem then
					actionBtn.Text = "ì¥ì°©í•˜ê¸°"
					actionBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
					actionBtn.Active = true
					previewPrice.Text = "ë³´ìœ ì¤‘"
				else
					actionBtn.Text = "êµ¬ë§¤í•˜ê¸°"
					actionBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
					actionBtn.Active = true
					previewPrice.Text = "ğŸ’° " .. data.Price
				end
			end
		end

		if container and template then
			template.Visible = false
			for _, child in pairs(container:GetChildren()) do
				if child ~= template and not child:IsA("UILayout") then child:Destroy() end
			end

			local sortedIds = {}
			for id, _ in pairs(ShopConfig) do table.insert(sortedIds, id) end
			table.sort(sortedIds)

			for _, id in ipairs(sortedIds) do
				local data = ShopConfig[id]
				local item = template:Clone()
				item.Name = "Item_" .. id
				item.Visible = true
				item.Parent = container

				if item:FindFirstChild("ItemName") then 
					item.ItemName.Text = data.Name 
					item.ItemName.Font = Enum.Font.LuckiestGuy 
				end
				if item:FindFirstChild("ItemImage") then item.ItemImage.Image = data.ImageId end

				if item:FindFirstChild("ItemPrice") then 
					item.ItemPrice.Font = Enum.Font.LuckiestGuy 
					if data.Price == 0 then item.ItemPrice.Text = "Free"
					else item.ItemPrice.Text = "ğŸ’°" .. data.Price end
				end

				local clickFunc = function() updatePreview(id) end
				if item:IsA("GuiButton") then item.MouseButton1Click:Connect(clickFunc)
				else
					local btn = item:FindFirstChildWhichIsA("GuiButton")
					if btn then btn.MouseButton1Click:Connect(clickFunc)
					else
						local touchBtn = Instance.new("TextButton")
						touchBtn.Size = UDim2.new(1,0,1,0)
						touchBtn.BackgroundTransparency = 1
						touchBtn.Text = ""
						touchBtn.Parent = item
						touchBtn.MouseButton1Click:Connect(clickFunc)
					end
				end
			end
		end

		if actionBtn then
			actionBtn.MouseButton1Click:Connect(function()
				local id = currentSelectedID
				local data = ShopConfig[id]
				local ownedStr = player:GetAttribute("OwnedSwords") or ""
				local hasItem = string.find(ownedStr, id .. ",")

				if hasItem then
					remotes.EquipItem:FireServer(id)
				else
					if coins.Value >= data.Price then
						remotes.BuyItem:FireServer(id)
					else
						local oldText = actionBtn.Text
						actionBtn.Text = "ëˆì´ ë¶€ì¡±í•´ìš”!"
						actionBtn.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
						task.wait(1)
						updatePreview(id)
					end
				end
			end)
		end
		if closeBtn then closeBtn.MouseButton1Click:Connect(function() shopFrame.Visible = false end) end

		local function refresh() updatePreview(currentSelectedID) end
		table.insert(uiConnections, equippedID.Changed:Connect(refresh))
		table.insert(uiConnections, player.AttributeChanged:Connect(refresh))
		table.insert(uiConnections, remotes.UpdateStats.OnClientEvent:Connect(refresh))

		task.delay(0.5, function()
			currentSelectedID = equippedID.Value or 1
			updatePreview(currentSelectedID)
		end)
	end

	local shopZone = Workspace:WaitForChild("ShopZone", 10)
	if shopZone and shopFrame then
		RunService.RenderStepped:Connect(function()
			local char = player.Character
			if not char or not char:FindFirstChild("HumanoidRootPart") then return end
			if (char.HumanoidRootPart.Position - shopZone.Position).Magnitude < 12 then
				if not shopFrame.Visible then
					shopFrame.Visible = true
					if equippedID then updatePreview(equippedID.Value) end
				end
			else
				if shopFrame.Visible then shopFrame.Visible = false end
			end
		end)
	end

	-- ==========================================================
	-- [B] í™˜ìƒ ì‹œìŠ¤í…œ
	-- ==========================================================
	local rebirthFrame = hud:FindFirstChild("RebirthFrame", true)
	local openBtn = hud:FindFirstChild("OpenRebirthBtn", true)

	if openBtn then openBtn.Visible = true end

	if rebirthFrame then
		rebirthFrame.ZIndex = 100 
		for _, desc in pairs(rebirthFrame:GetDescendants()) do
			if desc:IsA("GuiObject") then
				desc.ZIndex = desc.ZIndex + 100
			end
		end
	end

	local doRebirthBtn = rebirthFrame and rebirthFrame:FindFirstChild("DoRebirthBtn", true)
	local closeRebirthBtn = rebirthFrame and rebirthFrame:FindFirstChild("CloseBtn", true)

	local currentRangeLabel = rebirthFrame and rebirthFrame:FindFirstChild("CurrentRangeLabel", true)
	local nextRangeLabel = rebirthFrame and rebirthFrame:FindFirstChild("NextRangeLabel", true)

	local currentReqLabel = rebirthFrame and rebirthFrame:FindFirstChild("CurrentReqLabel", true)
	local nextReqLabel = rebirthFrame and rebirthFrame:FindFirstChild("NextReqLabel", true)

	local progressBarBg = rebirthFrame and rebirthFrame:FindFirstChild("ProgressBarBg", true)
	local progressBarFill = progressBarBg and progressBarBg:FindFirstChild("ProgressBarFill", true)
	local progressText = progressBarBg and progressBarBg:FindFirstChild("ProgressText", true)
	local resetText = rebirthFrame and rebirthFrame:FindFirstChild("ResetText", true)

	local targetFont = Enum.Font.LuckiestGuy
	local labels = {currentRangeLabel, nextRangeLabel, currentReqLabel, nextReqLabel, resetText, progressText}
	for _, lbl in ipairs(labels) do if lbl then lbl.Font = targetFont end end

	if doRebirthBtn then addHoverEffect(doRebirthBtn) end
	if openBtn then addHoverEffect(openBtn) end
	if closeRebirthBtn then addHoverEffect(closeRebirthBtn) end

	local function updateRebirthInfo()
		local r = rebirth.Value
		local curMult = 1 + (r * 0.5)
		local nextMult = 1 + ((r + 1) * 0.5)
		local currentMaxLevel = 25 + (r * 25)
		local nextMaxLevel = 25 + ((r + 1) * 25) 

		if currentRangeLabel then currentRangeLabel.Text = curMult .. "x Range" end
		if nextRangeLabel then nextRangeLabel.Text = nextMult .. "x Range" end

		if currentReqLabel then currentReqLabel.Text = "RangeLV " .. currentMaxLevel end
		if nextReqLabel then nextReqLabel.Text = "RangeLV " .. nextMaxLevel end

		if resetText then resetText.Text = "Rebirth resets your range level!" end

		if progressBarFill and progressText then
			local currentLv = level.Value
			local ratio = math.clamp(currentLv / currentMaxLevel, 0, 1)
			progressBarFill:TweenSize(UDim2.new(ratio, 0, 1, 0), "Out", "Quad", 0.2, true)
			progressText.Text = "RangeLV " .. currentLv .. " / " .. currentMaxLevel
		end
	end

	table.insert(uiConnections, level.Changed:Connect(updateRebirthInfo))
	table.insert(uiConnections, rebirth.Changed:Connect(updateRebirthInfo))
	task.delay(0.1, updateRebirthInfo)

	if openBtn then
		openBtn.MouseButton1Click:Connect(function() 
			if rebirthFrame then rebirthFrame.Visible = not rebirthFrame.Visible end 
		end)
	end
	if closeRebirthBtn then
		closeRebirthBtn.MouseButton1Click:Connect(function() 
			if rebirthFrame then rebirthFrame.Visible = false end 
		end)
	end
	if doRebirthBtn then
		doRebirthBtn.MouseButton1Click:Connect(function()
			local currentMaxLevel = 25 + (rebirth.Value * 25)
			if level.Value >= currentMaxLevel then
				remotes.Rebirth:FireServer()
				if rebirthFrame then rebirthFrame.Visible = false end
			end
		end)
	end

	-- ==========================================================
	-- [C] ê²½í—˜ì¹˜ ë°” ì‹œìŠ¤í…œ
	-- ==========================================================
	local expBarBg = createExpBar(hud)
	local expFill = expBarBg:FindFirstChild("ExpBarFill")
	local expText = expBarBg:FindFirstChild("LevelText")

	local visualLevel = level.Value
	local isAnimating = false

	local function updateExpVisuals()
		if isAnimating then return end 
		isAnimating = true

		local realLevel = level.Value
		local realExp = currentExp.Value
		local realMax = maxExp.Value
		if realMax <= 0 then realMax = 100 end

		if realLevel - visualLevel > 2 then visualLevel = realLevel end

		while visualLevel < realLevel do
			expFill:TweenSize(UDim2.new(1, 0, 1, 0), "Out", "Quad", 0.1, true) 
			task.wait(0.1)
			visualLevel = visualLevel + 1
			expText.Text = string.format("RangeLV %d [ LEVEL UP! ]", visualLevel)
			expFill.Size = UDim2.new(0, 0, 1, 0)
			task.wait(0.05)
		end

		local ratio = math.clamp(realExp / realMax, 0, 1)
		if realExp >= realMax then ratio = 1 end
		expFill:TweenSize(UDim2.new(ratio, 0, 1, 0), "Out", "Quad", 0.2, true)
		expText.Text = string.format("RangeLV %d [ %d / %d ]", realLevel, realExp, realMax)

		visualLevel = realLevel
		isAnimating = false
	end

	table.insert(uiConnections, currentExp.Changed:Connect(updateExpVisuals))
	table.insert(uiConnections, maxExp.Changed:Connect(updateExpVisuals))
	table.insert(uiConnections, level.Changed:Connect(updateExpVisuals))
	table.insert(uiConnections, remotes.UpdateStats.OnClientEvent:Connect(updateExpVisuals))
	updateExpVisuals()

	print("ClientSystem: UI ì—°ê²° ì™„ë£Œ!")
end

task.spawn(connectGameUI)
player.CharacterAdded:Connect(function() task.wait(1) connectGameUI() end)


------------------------------------------------------------------
-- 2. ë¬´ê¸° ë° ëª¬ìŠ¤í„° ì‹œìŠ¤í…œ (ê²€ ì„±ì¥ Yì¶• ì ìš©)
------------------------------------------------------------------
pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Backpack, false) end)

local function equipWeapon()
	local character = player.Character
	if not character then return end
	local humanoid = character:FindFirstChild("Humanoid")
	if not humanoid then return end

	local hidden = player:FindFirstChild("HiddenStats")
	local equippedID = hidden and hidden:FindFirstChild("EquippedSwordID") and hidden.EquippedSwordID.Value or 1
	local swordData = ShopConfig[equippedID]
	local damageVal = swordData and swordData.Damage or 10

	local currentTool = character:FindFirstChild("Sword")
	if not currentTool then
		local swordOrigin = ReplicatedStorage:FindFirstChild("Sword")
		if swordOrigin then
			local newSword = swordOrigin:Clone()
			local handle = newSword:FindFirstChild("Handle")
			if handle then
				handle.Anchored = false
				handle.CanCollide = false 
				handle.Massless = true
				handle.CanTouch = true
			end
			newSword:SetAttribute("Damage", damageVal) 
			newSword.Parent = player.Backpack
			humanoid:EquipTool(newSword)
		end
	else
		currentTool:SetAttribute("Damage", damageVal)
	end
end

local hidden = player:WaitForChild("HiddenStats", 10)
if hidden then
	local eqID = hidden:WaitForChild("EquippedSwordID", 10)
	if eqID then
		eqID.Changed:Connect(function()
			equipWeapon()
		end)
	end
end

player.CharacterAdded:Connect(function(char)
	task.wait(1) 
	equipWeapon()
	char.ChildRemoved:Connect(function(child)
		if child.Name == "Sword" then task.wait() equipWeapon() end
	end)
end)
if player.Character then task.wait(1) equipWeapon() end

-- [í•µì‹¬ ìˆ˜ì •] ë Œë”ìŠ¤í…: ê²€ ì„±ì¥ ë¡œì§ (Yì¶• ê¸¸ì´ ì‚¬ìš© & 0 ë‚˜ëˆ„ê¸° ë°©ì§€)
RunService.RenderStepped:Connect(function()
	local char = player.Character
	if not char then return end
	local tool = char:FindFirstChild("Sword")

	if tool and tool:FindFirstChild("Handle") and tool:FindFirstChild("Blade") then
		local handle = tool.Handle
		local blade = tool.Blade
		local level = player.leaderstats.Level.Value

		-- ê¸°ë³¸ ê¸¸ì´
		local baseLength = 4 
		local addedLength = (level - 1) * 0.5 
		local currentLength = baseLength + addedLength

		-- 1. ë¸”ë ˆì´ë“œ Yì¶• ê¸¸ì´ ëŠ˜ë¦¬ê¸° (X/ZëŠ” ì›ë˜ í¬ê¸° ìœ ì§€)
		blade.Size = Vector3.new(blade.Size.X, currentLength, blade.Size.Z)

		-- 2. Weld ë³´ì •
		local weld = blade:FindFirstChild("BladeWeld") or handle:FindFirstChild("BladeWeld")
		if not weld then
			weld = Instance.new("Weld")
			weld.Name = "BladeWeld"
			weld.Part0 = handle
			weld.Part1 = blade
			weld.Parent = blade

			-- ì´ˆê¸° ìœ„ì¹˜: (í•„ìš”í•˜ë©´ ê°’ ì¡°ì ˆ)
			weld.C0 = CFrame.new(0, 0.3, 0)
		end

		-- [ìœ„ì¹˜ ì´ë™] Yì¶•ìœ¼ë¡œ ì¤‘ì‹¬ ì´ë™
		-- (ê¸¸ì´ì˜ ì ˆë°˜)ë§Œí¼ -ë°©í–¥ìœ¼ë¡œ ì´ë™ì‹œì¼œì•¼ 'ë°‘ë°”ë‹¥'ì´ ì†ì¡ì´ì— ë¶™ì–´ìˆê²Œ ë¨
		-- ë§Œì•½ ê±°ê¾¸ë¡œ ìë€ë‹¤ë©´ -currentLength / 2ë¥¼ +currentLength / 2ë¡œ ë°”ê¾¸ì„¸ìš”.
		weld.C1 = CFrame.new(0, -currentLength / 2, 0)
	end
end)

local MOB_DATA = {
	["ì´ˆë³´ ëª¹"] = { ModelName = "ZombieModel", MaxHealth = 100, WalkSpeed = 0 },
	["ì¤‘ìˆ˜ ëª¹"] = { ModelName = "StrongZombie", MaxHealth = 500, WalkSpeed = 0 },
	["ë³´ìŠ¤"] = { ModelName = "BossZombie", MaxHealth = 5000, WalkSpeed = 0 }
}
local mobFolder = Instance.new("Folder")
mobFolder.Name = "PrivateMobs"
mobFolder.Parent = Workspace
local spawnerFolder = Workspace:WaitForChild("MobSpawners", 10)

local function getZombieModel(spawnerName, color, position)
	local data = MOB_DATA[spawnerName] or { ModelName = "ZombieModel", MaxHealth = 100, WalkSpeed = 0 }
	local targetModelName = data.ModelName
	local savedModel = ReplicatedStorage:FindFirstChild(targetModelName) or ReplicatedStorage:FindFirstChild("ZombieModel")
	if not savedModel then return nil, nil end

	local model = savedModel:Clone()
	model.Name = spawnerName
	model:PivotTo(CFrame.new(position + Vector3.new(0, 3, 0)))

	local humanoid = model:FindFirstChild("Humanoid") or Instance.new("Humanoid", model)
	humanoid.MaxHealth = data.MaxHealth
	humanoid.Health = data.MaxHealth
	humanoid.WalkSpeed = data.WalkSpeed
	for _, part in pairs(model:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Anchored = true
			part.CanCollide = false
			part.CanTouch = true
		end
	end
	local head = model:FindFirstChild("Head") or model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
	if head then
		local bg = Instance.new("BillboardGui")
		bg.Name = "HealthBarGui"
		bg.Adornee = head
		bg.Size = UDim2.new(5, 0, 1, 0)
		bg.StudsOffset = Vector3.new(0, 3, 0)
		bg.AlwaysOnTop = true
		bg.Parent = model
		local barBg = Instance.new("Frame")
		barBg.Size = UDim2.new(1, 0, 0.25, 0)
		barBg.Position = UDim2.new(0, 0, 0.6, 0)
		barBg.BackgroundColor3 = Color3.new(0,0,0)
		barBg.Parent = bg
		local healthFill = Instance.new("Frame")
		healthFill.Size = UDim2.new(1, 0, 1, 0)
		healthFill.BackgroundColor3 = Color3.fromRGB(85, 255, 127)
		healthFill.Parent = barBg
		local nameLabel = Instance.new("TextLabel")
		nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
		nameLabel.BackgroundTransparency = 1
		nameLabel.Text = spawnerName .. " [HP: " .. math.floor(humanoid.Health) .. "]"
		nameLabel.TextColor3 = Color3.new(1,1,1)
		nameLabel.Font = Enum.Font.FredokaOne
		nameLabel.TextScaled = true
		nameLabel.Parent = bg
		humanoid.HealthChanged:Connect(function(health)
			local ratio = health / humanoid.MaxHealth
			healthFill:TweenSize(UDim2.new(ratio, 0, 1, 0), "Out", "Quad", 0.1, true)
			nameLabel.Text = spawnerName .. " [HP: " .. math.floor(health) .. "]"
			if ratio < 0.3 then healthFill.BackgroundColor3 = Color3.fromRGB(255, 85, 85)
			else healthFill.BackgroundColor3 = Color3.fromRGB(85, 255, 127) end
		end)
	end
	return model, humanoid
end
local function spawnMobAt(spawnPart)
	if not spawnPart then return end
	spawnPart.Transparency = 1 
	local mobName = spawnPart.Name 
	local mob, humanoid = getZombieModel(mobName, spawnPart.Color, spawnPart.Position)
	if not mob then return end
	mob.Parent = mobFolder
	local debounce = false
	for _, part in pairs(mob:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Touched:Connect(function(hit)
				if debounce then return end
				local tool = hit.Parent
				if tool:IsA("Tool") and tool.Parent == player.Character and (hit.Name == "Handle" or hit.Name == "Blade") then
					local isAttacking = tool:GetAttribute("IsAttacking")
					if isAttacking == true then
						debounce = true
						local damage = tool:GetAttribute("Damage") or 10
						humanoid:TakeDamage(damage)
						spawn(function()
							part.Color = Color3.new(1, 0, 0)
							task.wait(0.1)
							part.Color = Color3.new(1,1,1)
						end)
						if humanoid.Health <= 0 then
							remotes.MobKill:FireServer(mobName)
							mob:Destroy()
							task.wait(3) 
							spawnMobAt(spawnPart)
						else
							task.wait(0.2) 
							debounce = false
						end
					end
				end
			end)
		end
	end
end
if spawnerFolder then
	for _, spawner in pairs(spawnerFolder:GetChildren()) do
		if spawner:IsA("BasePart") then spawnMobAt(spawner) end
	end
end
